<!DOCTYPE html>
<html lang="en" dir="ltr">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title></title>
		<meta name="description" content="description du site web">
		<meta name="keywords" content="truc, bidule, chouette">
<!--
		<link href="./style.css" type="text/css" rel="stylesheet">
		<script type="text/javascript" src="script.js" defer></script>
-->
	<style>
		#red {background-color: red;}
	</style>
	</head>
	<body>

		<div id="scribb">
			<h1>ihcra</h1>
			<input id="search" type="text" placeholder="recherche un theme"/ autofocus>
			<div id="liste"></div>
		</div>

		<script>
			const list = document.getElementById("liste");
			const search = document.getElementById("search");
			search.addEventListener("keyup", compareSearch);
			const data = []

			fetch("notes.json")
				.then(i => i.json())
				.then(i => i.notes.forEach(e => data.push(e)))
				.then(console.log(data))
				.then(compareSearch)

			function compareSearch() {
				let toPrint = []
				let research = search.value.toLowerCase()
				let regex = new RegExp(research, 'g')
				let become = "<span id='red'>" + research + "</span>"
				/* si rien n'est en recherche on affiche tout */
				printSelection(data)
				/* mais si on cherche qqch on affiche le resultat */
				if(search.value.toLowerCase() !== '') {
					/* parcour toutes les sections par indexAll de data */
					/* et pour chacune, objet, parcour les key de l'objet */
					data.forEach((section, indexAll) => Object.keys(section).forEach(key => {
						/* chaque key est un tableau de string, on parcour... */
						section[key].forEach((paragraph, index) => {
							/* in case the search pattern is found in a string */
							/* replace it by itself surrounded with html balises for highlight */
							/* and fill "print" with a copy of the section containing it */
							if (paragraph.includes(research)) {
								const change = paragraph.replace(regex, become)
								const tmp = JSON.parse(JSON.stringify(data[indexAll]))
								/* si cette section existe deja on ne la rajoute pas a toPrint */
								if (!(toPrint.some(e => e.title.includes(section.title[0]))))
									toPrint.push(tmp)
								toPrint[toPrint.length - 1][key].splice(index, 1, change)
							}
						})
					}))
					printSelection(toPrint)
				}
			}

			function printSelection(affich) {
				let html = ''
				for(let i of affich) {
					html += `<div><h1 id="title">${i.title[0]}</h1>`
					if (i.title.length > 1)
						for(let j = 1; j < i.title.length; j++)
							html += `<div><h2 id="subtitle">${i.title[j]}</h2>`
					for(j = 0; j < i.content.length; j++)
						html += `<p id="content">${i.content[j]}</p>`
					html += "<div>"
					for(j = 0; j < i.keywords.length; j++)
						html += `<p id="keywords">${i.keywords[j]}</p>`
					html += "</div></div>"
				}
				list.innerHTML = html
			}

		</script>

</body>
</html>
